name: PyDaily Bot Schedule

on:
  schedule:
    # 7:00 AM IST = 1:30 AM UTC
    - cron: '30 1 * * *'
    # 10:00 PM IST = 4:30 PM UTC
    - cron: '30 16 * * *'
  workflow_dispatch: # Allows manual trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          cd PyDailyEmail
          pip install -r requirements.txt

      - name: Determine Mode
        id: mode
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" -lt "12" ]; then
            echo "mode=morning" >> $GITHUB_OUTPUT
            echo "Running Morning Cycle"
          else
            echo "mode=evening" >> $GITHUB_OUTPUT
            echo "Running Evening Cycle"
          fi

      - name: Run Bot
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          # Safe approach: Use Python to write the JSON file from Secret
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          cd PyDailyEmail
          
          # 0. FORCE INSTALL DEPENDENCIES (Brute Force Fix v2 - RE-TRIGGER)
          pip install gspread oauth2client google-generativeai python-dotenv pandas google-auth
          
          # 1. Reconstruct Service Account File safely
          python -c "import os; open('service_account.json','w').write(os.environ['GOOGLE_CREDENTIALS'])"
          
          # 2. Debug (Check if file exists)
          ls -l service_account.json
          
          # 3. Import Check
          python -c "import backend.data_manager; print('Import OK')"
          
          # 4. Run Bot
          python run_bot.py --mode ${{ steps.mode.outputs.mode }}
